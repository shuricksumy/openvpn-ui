{{ template "layout/base.html" . }}

{{define "head"}}
<title>OpenVPN - Certificates</title>
{{end}}

{{define "body"}}

{{template "common/alert.html" .}}  

<div class="col-md-12">
  <div class="card card-primary">
    <div class="card-header with-border">
      <table>
        <tr>
          <td class="col-md-1 text-left"><a class="btn btn-success btn-sm btn120" data-toggle="collapse" href="#newCert" role="button"  aria-expanded="false"
                  aria-controls="newCert" style="margin-left: 0.5%;">Create New Certificate</a></td>
          <td class="col-md-1 text-right"><i>Restart server after revocation:&nbsp;&nbsp;&nbsp;</i><a href="{{urlfor "CertificatesController.Restart"}}" class="btn btn-danger btn-sm bg-red-gradient btn150" data-title="Restart OpenVPN container?" 
                  title="Restart OpenVPN container" style="margin-right: 23px;">Restart OpenVPN Server</a></td>
        </tr>
      </table>
    </div>
    <!-- /.card-header -->
    <!-- form start -->

    <div id="newCert" class="collapse">
    <form id="form-to-confirm" role="form" action="{{urlfor "CertificatesController.Post"}}" method="post">
      <div class="card-body">

    <div class="form-row">
      
          <div class="form-group col-md-4 {{if field_error_exist .validation "Name" }}has-error{{end}}">
              <label for="Name">Name*</label>
              <input type="text" class="form-control" placeholder="Enter name" id="Name" name="Name" required onfocusout="this.value = this.value.trim()">
              <span class="help-block">Common name of the certificate.&nbsp;&nbsp;&nbsp;<span>
          </div>

          <div class="form-group col-md-4">
              <label for="passphrase">Passphrase (Optional)</label>
              <div class="input-group">
                  <input type="password" class="form-control pwd" placeholder="Enter Password"  id="passphrase" name="passphrase">
                  <span class="input-group-btn">
                      <button class="btn btn-default reveal" type="button"><i class="fa fa-eye"></i></button>
                  </span>
              </div>
              <span class="help-block">Passphrase is used for privte key protection.&nbsp;&nbsp;&nbsp;</span>
          </div>

        <div class="form-group col-md-4">
              <label for="description">Description (Optional)</label>
              <input type="text" class="form-control" placeholder="Add description" id="description" 
                name="description" onfocusout="this.value = this.value.trim()">
              <span class="help-block">Client Static IP used as a local Client IP for subnet split.</span>
        </div>

    </div>

      <span class="help-block"> {{template "common/fvalid.html" field_error_message .validation "Name" }}</span>
      </div>
      <!-- /.card-body -->

      <div class="card-footer">
        <button type="submit" class="btn btn-primary btn-sm bg-light-blue-gradient btn80 form-to-confirm" 
          style="margin-right: 23px; float: right;" data-title="Create new client?">Create</button>
      </div>
    </form>
  </div>
  </div>
</div>



  <div class="col-md-12">
    <div class="card card-primary">
      <div class="card-header with-border">
        <h3 class="card-title">Clients certificates</h3>

      </div>
      <!-- /.card-header -->

      <div class="card-body p-0">
        <div class="table-responsive">
         <table class="table m-0">
            <thead>
            <tr>
              <th style="width:25%">Name</th>
              <th style="width:5%">State</th>
              <th style="width:45%">Description</th>
              <th style="width:15%">Expiration</th>
              <th class="textcenter" style="width:5%">Actions</th>
              <th class="textcenter" style="width:5%">Details</th>
            </tr>
            </thead>
            <tbody>

            {{$MD5 := .MD5}}  
            {{range $c := .certificates}}
              <tr>

                  <!-- 1 sell -->
                  {{if eq .EntryType "V"}}
                  <td>
                    <a href="{{urlfor "CertificatesController.Download" ":key" .Details.CN}}" 
                      class="btn btn-primary btn-sm btn-group-sm btn-block bg-light-blue-gradient right-icon-holder" title="{{ .Details.CN }}">
                      {{ .Details.CN }}.ovpn<i class="fa fa-download"></i>
                    </a>
                  </td>
                  {{else}}
                  <td>
                    <a href="" class="btn btn-default btn-sm btn-group-sm disabled btn-block" title="Download">
                      {{ .Details.CN }}
                    </a>
                  </td>
                  {{end}}

                   <!-- 2 sell -->
                  {{if eq .EntryType "V"}}
                    <td>
                      <button type="button" class="btn btn-success btn-sm btn-group-sm bg-green-gradient" 
                        data-toggle="modal" data-target="#popup-{{ .Details.CN }}">
                        <i class="fa fa-info-circle"></i>
                      </button>
                    </td>
                  {{else if eq .EntryType "R"}}
                    <td>
                       <button type="button" class="btn btn-warning btn-sm btn-group-sm bg-yellow-gradient" 
                        data-toggle="modal" data-target="#popup-{{ .Details.CN }}">
                        <i class="fa fa-info-circle"></i>
                        </button>
                    </td>
                   {{else}}
                     <td>
                         <button type="button" class="btn btn-danger btn-sm btn-group-sm bg-red" 
                          data-toggle="modal" data-target="#popup-{{ .Details.CN }}">
                            <span class="fa fa-info-circle">
                        </button>
                     </td>
                   {{end}}

                    <!-- 3 sell -->
                    <td>
                      {{ .Details.Description }}
                    </td>

                   <!-- 4 sell -->
                    <td class="my-centered">
                      <span class="btn btn-xs btn-group-xs bg-gray">{{ dateformat .ExpirationT "2006-01-02 15:04"}}</span>
                    </td>

                    <!-- 5 sell -->
                     <!-- <td>
                      {{ .Serial }}
                     </td> -->

                <!--    <td>
                      <span class="label label-warning">CN: {{ .Details.CN }}</span>
                      Comented until bypass of client email to DB will be implemented 
                      <span class="label label-warning">Email: {{ .Details.Email }}</span>
                    </td> -->

                   <!-- 6 sell -->
                  {{if eq .EntryType "V"}}
                    <td class="textcenter">
                      <a href="{{urlfor "CertificatesController.Revoke" ":key" .Details.CN}}" data-title="Disable access for user?" 
                        class="btn btn-warning btn-sm btn-group-sm bg-yellow-gradient btn80" title="Revoke">Revoke</a>
                      <!-- <a href="{{urlfor "CertificatesController.Renew" ":key" .Details.CN ":serial" .Serial}}" 
                          data-title="Restore certificates?" class="btn btn-warning btn-sm bg-yellow-gradient btn80" title="Burn">Renew</a> -->
                    </td>
                  {{else if eq .EntryType "R"}}
                    <td class="textcenter">
                      <div class="btn-group" role="group">
                          <a href="{{urlfor "CertificatesController.Burn" ":key" .Details.CN ":serial" .Serial}}" 
                            data-title="Remove certificates ?" class="btn btn-danger btn-sm btn-group-sm bg-red-gradient btn40" title="Remove">RM</a>
                          <a href="{{urlfor "CertificatesController.UnRevoke" ":key" .Details.CN}}" style="border-color: #d73925;"
                            data-title="Restore access for user?" class="btn btn-warning btn-sm btn-group-sm bg-green-gradient btn40" title="UNRevoke">UN</a>
                          <!-- <a href="{{urlfor "CertificatesController.Renew" ":key" .Details.CN ":serial" .Serial}}" 
                            data-title="Restore certificates?" class="btn btn-warning btn-sm bg-yellow-gradient btn80" title="Burn">Renew</a> -->
                      </div>
                    </td>
                  {{else}}
                    <td>
                      <a href="" class="btn btn-default btn-sm btn-group-sm disabled btn-block" title="Fix">Fix manualy</a>
                    </td>
                  {{end}}


                  <!-- 7 sell -->
                  {{ $col := "btn-primary btn-sm btn-group-sm bg-light-blue-gradient" }}  
                  {{ $comment := "Edit" }} 
                  {{ $isValid := true }}
                  {{ range $md5 := $MD5 }}
                      {{ if eq $md5.ClientName $c.Details.CN }}
                          {{ if not $md5.IsValid }} 
                              {{ $col = "btn-danger btn-sm btn-group-sm bg-red" }}
                              {{ $comment = "Config was changed but not applied !" }}
                              {{ $isValid = false }} 
                          {{ end }}
                      {{ end }}
                  {{ end }}
                  {{if eq .EntryType "V"}}
                    <td class="textcenter">
                      <button  id="openModalEditClientRaw" data-target="#editClientModalRaw" data-client-name="{{ .Details.CN }}" 
                        class="btn {{ $col }} btn80 but-center right-icon-holder" title="{{ $comment }}">Edit
                      {{if not $isValid }} <i class='fa fa-warning'></i> {{end}}
                      </button>
                    </td>
                  {{else}}
                    <td class="textcenter">
                      <button  id="openModalEditClientRaw" data-target="#editClientModalRaw" data-client-name="{{ .Details.CN }}"  
                        class="btn btn-default btn-sm btn-group-sm edit-button btn80 but-center right-icon-holder" title="{{ $comment }}">Edit
                        {{if not $isValid }} <i class='fa fa-warning'></i> {{end}}
                      </button>
                    </td>
                  {{end}}

                  </tr>

                  <div id="popup-{{ .Details.CN }}" class="modal fade" role="dialog">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h4 class="modal-title">{{ .Details.CN }}</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" data-form-type="" data-dashlane-label="true">
                              <span aria-hidden="true">×</span>
                            </button>
                          </div>
                          <div class="modal-body">
                             <span class="param-name"><b>Name:</b></span><span class="param-value"> {{ .Details.CN }}</span><br>
                             <span class="param-name"><b>Description:</b></span><span class="param-value"> {{ .Details.Description }}</span><br>
                             <span class="param-name"><b>Type:</b></span><span class="param-value"> {{ .EntryType }}</span><br>
                             <span class="param-name"><b>Status:</b></span><span class="param-value">{{if eq .EntryType "V"}}  Active {{else if eq .EntryType "R"}} Revoked {{else}} Unknown {{end}}</span><br>
                             <span class="param-name"><b>Serial:</b></span><span class="param-value"> {{ .Serial }}</span><br>
                             <span class="param-name"><b>IP Address</b>:</span><span class="param-value"> {{ .Details.LocalIP }}</span><br>
                             <span class="param-name"><b>Expiration Date:</b></span><span class="param-value">{{ dateformat .ExpirationT "2006-01-02 15:04"}}</span><br>
                             <span class="param-name"><b>Revoke Date:</b></span><span class="param-value">{{if ne .Revocation ""}} {{ dateformat .RevocationT "2006-01-02 15:04"}} {{else}} none {{end}}</span><br>
                          </div>
                          <div class="modal-footer">   
                             <!-- Copy button -->
                             <button class="btn btn-primary bg-light-blue-gradient btn80" data-dismiss="modal">Close</button>
                          </div>
                        </div>
                     </div>
                  </div>
            {{end}}
            </tbody>
          </table>
        </div>
       </div>
        <!-- /.table-responsive -->
      </div>
      <!--else
          Fix your configuration
      end-->

     <!--
      <div class="card-footer clearfix">
        
      </div>
      -->

      <!--
      <div class="card-footer clearfix">
        <a href="javascript:void(0)" class="btn btn-sm btn-info btn-flat pull-left">Place New Order</a>
        <a href="javascript:void(0)" class="btn btn-sm btn-default btn-flat pull-right">View All Orders</a>
      </div>
    -->
      <!-- /.card-footer -->
    </div>
    <!-- /.card -->
  </div>

<script type="text/javascript">
  var actionURL="/certificates/save_client_data" 
</script>
<!-- Add an empty modal container -->
<div id="modal-edit-client-raw"></div>
{{end}}


<div id="overlay">
  <div class="cv-spinner">
    <span class="spinner"></span>
  </div>
</div>
